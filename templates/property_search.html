{% extends "unified_base.html" if ui_template == "unified" else "base.html" %}

{% block title %}Property Search{% endblock %}

{% if ui_template == "unified" %}
    {# Import unified UI components #}
    {% from "components/ui_components.html" import card, action_button, status_badge, data_table %}
    {% from "components/loading_states.html" import data_loading_container %}
    {% from "components/error_states.html" import empty_state, error_alert %}
    {% from "components/property_search.html" import property_search_form, property_search_results, property_search_loading %}
{% endif %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="mb-4 text-center">
                <h1 class="h2 mb-3">Property Search</h1>
                <p class="lead text-muted">Search for detailed property information and market analysis</p>
            </div>
            
            {% if ui_template == "unified" %}
                {{ property_search_form(search_url=url_for('property_search'), default_value=query, advanced=True) }}
            {% else %}
                <form action="{{ url_for('property_search') }}" method="GET" class="mb-4">
                    <div class="input-group mb-3">
                        <input type="text" name="query" class="form-control form-control-lg" 
                               placeholder="Enter property address, city, state or zip code" 
                               value="{{ query }}" required>
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-search me-1"></i> Search
                        </button>
                    </div>
                    
                    <div class="card p-3 mb-4">
                        <div class="row g-3">
                            <div class="col-md-6 col-lg-3">
                                <label for="propertyType" class="form-label">Property Type</label>
                                <select class="form-select" id="propertyType" name="propertyType">
                                    <option value="" selected>All Types</option>
                                    <option value="residential">Residential</option>
                                    <option value="commercial">Commercial</option>
                                    <option value="land">Land</option>
                                    <option value="industrial">Industrial</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label for="minPrice" class="form-label">Min Price</label>
                                <input type="number" class="form-control" id="minPrice" name="minPrice" placeholder="$">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label for="maxPrice" class="form-label">Max Price</label>
                                <input type="number" class="form-control" id="maxPrice" name="maxPrice" placeholder="$">
                            </div>
                            <div class="col-md-6 col-lg-3">
                                <label for="radius" class="form-label">Search Radius</label>
                                <select class="form-select" id="radius" name="radius">
                                    <option value="0" selected>Exact Address</option>
                                    <option value="0.5">0.5 miles</option>
                                    <option value="1">1 mile</option>
                                    <option value="3">3 miles</option>
                                    <option value="5">5 miles</option>
                                    <option value="10">10 miles</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            {% endif %}
            
            {% if is_loading %}
                {% if ui_template == "unified" %}
                    {{ property_search_loading() }}
                {% else %}
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <h4 class="mt-3">Searching properties...</h4>
                    </div>
                {% endif %}
            {% elif error %}
                {% if ui_template == "unified" %}
                    {{ error_alert(error, title="Search Error") }}
                {% else %}
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading">Search Error</h4>
                        <p>{{ error }}</p>
                    </div>
                {% endif %}
            {% elif properties %}
                <div class="mb-4">
                    <h2 class="h4">Search Results</h2>
                    <p class="text-muted">Found {{ properties|length }} properties matching your criteria</p>
                </div>
                
                {% if ui_template == "unified" %}
                    {{ property_search_results(properties, show_map=True) }}
                {% else %}
                    {% if properties|length > 0 %}
                        <div class="map-container mb-4">
                            <div id="property-map" style="height: 400px;"></div>
                        </div>
                        
                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                            {% for property in properties %}
                            <div class="col">
                                <div class="card h-100">
                                    {% if property.image_url %}
                                    <img src="{{ property.image_url }}" class="card-img-top" alt="{{ property.address }}">
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ property.address }}</h5>
                                        <h6 class="card-subtitle mb-2 text-muted">{{ property.city }}, {{ property.state }} {{ property.zip_code }}</h6>
                                        
                                        <div class="property-price my-2">
                                            <span class="fs-4 fw-bold">${{ property.price }}</span>
                                        </div>
                                        
                                        <div class="property-features d-flex justify-content-between text-center mb-3">
                                            {% if property.bedrooms is defined %}
                                            <div class="feature">
                                                <div class="feature-value">{{ property.bedrooms }}</div>
                                                <div class="feature-label text-muted small">Beds</div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if property.bathrooms is defined %}
                                            <div class="feature">
                                                <div class="feature-value">{{ property.bathrooms }}</div>
                                                <div class="feature-label text-muted small">Baths</div>
                                            </div>
                                            {% endif %}
                                            
                                            {% if property.sqft is defined %}
                                            <div class="feature">
                                                <div class="feature-value">{{ property.sqft }}</div>
                                                <div class="feature-label text-muted small">Sq.ft</div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-footer bg-transparent">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span class="text-muted small">{{ property.property_type }}</span>
                                            <div>
                                                <a href="{{ url_for('property_details', property_id=property.id) }}" class="btn btn-sm btn-outline-primary">
                                                    Details
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-house-slash" style="font-size: 3rem; opacity: 0.5;"></i>
                            <h4 class="mt-3 text-muted">No properties found matching your search criteria</h4>
                        </div>
                    {% endif %}
                {% endif %}
            {% elif query %}
                {% if ui_template == "unified" %}
                    {{ empty_state(
                        message="No properties found matching your search criteria", 
                        icon="house-slash",
                        container_classes="py-5"
                    ) }}
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-house-slash" style="font-size: 3rem; opacity: 0.5;"></i>
                        <h4 class="mt-3 text-muted">No properties found matching your search criteria</h4>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if properties and properties|length > 0 %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&callback=initMap" async defer></script>
<script>
    function initMap() {
        const properties = {{ properties_json|safe }};
        const map = new google.maps.Map(document.getElementById("property-map"), {
            zoom: 14,
            center: { lat: properties[0].latitude, lng: properties[0].longitude },
        });
        
        properties.forEach(property => {
            const marker = new google.maps.Marker({
                position: { lat: property.latitude, lng: property.longitude },
                map,
                title: property.address,
            });
            
            const infowindow = new google.maps.InfoWindow({
                content: `
                    <div class="property-info-window">
                        <h6>${property.address}</h6>
                        <p>${property.city}, ${property.state} ${property.zip_code}</p>
                        <p class="fw-bold">$${property.price}</p>
                        <a href="/property/${property.id}" class="btn btn-sm btn-primary">View Details</a>
                    </div>
                `,
            });
            
            marker.addListener("click", () => {
                infowindow.open(map, marker);
            });
        });
    }
</script>
{% endif %}
{% endblock %}