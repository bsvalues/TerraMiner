{% extends "base.html" %}

{% block title %}Generate CMA Report | TerraMiner{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">
                <i class="fas fa-chart-line mr-2"></i> Generate CMA Report
            </h2>
        </div>
        <div class="card-body">
            <p class="mb-4">Enter the subject property details below to generate a comprehensive comparative market analysis report.</p>
            
            <form method="post" action="{{ url_for('cma_ui.cma_generator') }}" id="cma-generator-form">
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="mb-3">Property Location</h5>
                        <div class="form-group">
                            <label for="subject_address">Address*</label>
                            <input type="text" class="form-control" id="subject_address" name="subject_address" 
                                   placeholder="Start typing to search for an address..." 
                                   value="{{ form_data.subject_address if form_data else '' }}" required 
                                   autocomplete="off">
                            <div id="property-suggestions" class="shadow-sm border rounded position-absolute bg-white w-100 z-index-100 d-none">
                                <div class="list-group list-group-flush" id="property-suggestions-list">
                                    <!-- Property suggestions will be populated here -->
                                </div>
                                <div id="search-status" class="small text-center text-muted p-2 d-none">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="sr-only">Searching...</span>
                                    </div>
                                    <span class="ml-2">Searching...</span>
                                </div>
                            </div>
                        </div>
                
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="subject_city">City*</label>
                                <input type="text" class="form-control" id="subject_city" name="subject_city" 
                                       placeholder="San Francisco" value="{{ form_data.subject_city if form_data else '' }}" required>
                            </div>
                            <div class="form-group col-md-3">
                                <label for="subject_state">State*</label>
                                <input type="text" class="form-control" id="subject_state" name="subject_state" 
                                       placeholder="CA" maxlength="2" value="{{ form_data.subject_state if form_data else '' }}" required>
                            </div>
                            <div class="form-group col-md-3">
                                <label for="subject_zip">ZIP Code*</label>
                                <input type="text" class="form-control" id="subject_zip" name="subject_zip" 
                                       placeholder="94105" value="{{ form_data.subject_zip if form_data else '' }}" required>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Why this matters?</h6>
                                <p class="card-text small">We use the property location to find comparable properties in the same area. Accurate location information helps ensure the most relevant comparable properties are included in your analysis.</p>
                                <div class="alert alert-info small mb-0">
                                    <i class="fas fa-info-circle mr-1"></i> Tip: Start typing an address to automatically find and fill in property details from our database.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="row">
                    <div class="col-md-8">
                        <h5 class="mb-3">Property Details</h5>
                        <div class="form-row">
                            <div class="form-group col-md-3">
                                <label for="subject_beds">Bedrooms</label>
                                <input type="number" class="form-control" id="subject_beds" name="subject_beds" 
                                       min="0" step="1" value="{{ form_data.subject_beds if form_data else '3' }}">
                            </div>
                            <div class="form-group col-md-3">
                                <label for="subject_baths">Bathrooms</label>
                                <input type="number" class="form-control" id="subject_baths" name="subject_baths" 
                                       min="0" step="0.5" value="{{ form_data.subject_baths if form_data else '2' }}">
                            </div>
                            <div class="form-group col-md-3">
                                <label for="subject_sqft">Square Footage</label>
                                <input type="number" class="form-control" id="subject_sqft" name="subject_sqft" 
                                       min="0" step="1" value="{{ form_data.subject_sqft if form_data else '1800' }}">
                            </div>
                            <div class="form-group col-md-3">
                                <label for="subject_lot_size">Lot Size (sq ft)</label>
                                <input type="number" class="form-control" id="subject_lot_size" name="subject_lot_size" 
                                       min="0" step="1" value="{{ form_data.subject_lot_size if form_data else '5000' }}">
                            </div>
                        </div>
                
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label for="subject_year_built">Year Built</label>
                                <input type="number" class="form-control" id="subject_year_built" name="subject_year_built" 
                                       min="1800" max="2025" step="1" value="{{ form_data.subject_year_built if form_data else '2000' }}">
                            </div>
                            <div class="form-group col-md-4">
                                <label for="subject_property_type">Property Type</label>
                                <select class="form-control" id="subject_property_type" name="subject_property_type">
                                    <option value="Single Family" {% if form_data and form_data.subject_property_type == 'Single Family' %}selected{% endif %}>Single Family</option>
                                    <option value="Condo" {% if form_data and form_data.subject_property_type == 'Condo' %}selected{% endif %}>Condo</option>
                                    <option value="Townhouse" {% if form_data and form_data.subject_property_type == 'Townhouse' %}selected{% endif %}>Townhouse</option>
                                    <option value="Multi-Family" {% if form_data and form_data.subject_property_type == 'Multi-Family' %}selected{% endif %}>Multi-Family</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label for="subject_price">Current Price (optional)</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">$</span>
                                    </div>
                                    <input type="number" class="form-control" id="subject_price" name="subject_price" 
                                           min="0" step="1000" value="{{ form_data.subject_price if form_data else '' }}" placeholder="e.g., 750000">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">Why these details matter?</h6>
                                <p class="card-text small">We use these property characteristics to find the most similar comparable properties and make appropriate price adjustments. The more accurate these details are, the more precise your property valuation will be.</p>
                                <p class="card-text small">Current price is optional and helps calibrate our AI recommendations.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mt-4 text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-magic mr-2"></i> Generate Report
                    </button>
                    <a href="{{ url_for('cma_ui.cma_home') }}" class="btn btn-secondary btn-lg ml-2">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JavaScript for property lookup functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addressInput = document.getElementById('subject_address');
    const suggestionsContainer = document.getElementById('property-suggestions');
    const suggestionsList = document.getElementById('property-suggestions-list');
    const searchStatus = document.getElementById('search-status');
    
    let searchTimeout = null;
    let currentSearchTerm = '';
    
    // Function to populate form with property data
    function populatePropertyData(property) {
        // Fill in the form fields with property data
        document.getElementById('subject_address').value = property.address;
        document.getElementById('subject_city').value = property.city;
        document.getElementById('subject_state').value = property.state;
        document.getElementById('subject_zip').value = property.zip_code;
        document.getElementById('subject_beds').value = property.beds;
        document.getElementById('subject_baths').value = property.baths;
        document.getElementById('subject_sqft').value = property.sqft;
        document.getElementById('subject_lot_size').value = property.lot_size;
        document.getElementById('subject_year_built').value = property.year_built;
        
        // Set property type if it matches one of our options
        const propertyTypeSelect = document.getElementById('subject_property_type');
        const propertyType = property.property_type;
        
        for (let i = 0; i < propertyTypeSelect.options.length; i++) {
            if (propertyTypeSelect.options[i].value === propertyType) {
                propertyTypeSelect.selectedIndex = i;
                break;
            }
        }
        
        // Set price if available
        if (property.price) {
            document.getElementById('subject_price').value = property.price;
        }
        
        // Hide suggestions
        suggestionsContainer.classList.add('d-none');
    }
    
    // Function to fetch and display property suggestions
    function lookupProperty(address) {
        // Check if address has changed
        if (address === currentSearchTerm) {
            return;
        }
        
        currentSearchTerm = address;
        
        if (address.length < 3) {
            suggestionsContainer.classList.add('d-none');
            return;
        }
        
        // Show loading indicator
        suggestionsList.innerHTML = '';
        searchStatus.classList.remove('d-none');
        suggestionsContainer.classList.remove('d-none');
        
        // Make API call to lookup property
        fetch(`/cma/api/lookup-property?address=${encodeURIComponent(address)}`)
            .then(response => response.json())
            .then(data => {
                // Hide loading indicator
                searchStatus.classList.add('d-none');
                
                // Clear previous suggestions
                suggestionsList.innerHTML = '';
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const properties = data.properties || [];
                
                if (properties.length === 0) {
                    suggestionsList.innerHTML = `
                        <div class="list-group-item text-center text-muted py-3">
                            <i class="fas fa-home mr-2"></i> No properties found
                        </div>
                    `;
                    return;
                }
                
                // If only one property found and exact match, auto-populate
                if (properties.length === 1 && 
                    properties[0].address.toLowerCase() === address.toLowerCase()) {
                    populatePropertyData(properties[0]);
                    return;
                }
                
                // Add found properties to suggestions
                properties.forEach(property => {
                    const item = document.createElement('a');
                    item.className = 'list-group-item list-group-item-action';
                    item.href = '#';
                    
                    // Format display of property
                    const displayAddress = `${property.address}, ${property.city}, ${property.state} ${property.zip_code}`;
                    const details = `${property.beds} beds, ${property.baths} baths, ${property.sqft} sqft`;
                    
                    item.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${displayAddress}</h6>
                            ${property.price ? `<span class="text-success">$${property.price.toLocaleString()}</span>` : ''}
                        </div>
                        <p class="mb-1 small">${details}</p>
                        <small>${property.property_type} | Built ${property.year_built}</small>
                    `;
                    
                    // Add click event to populate form
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        populatePropertyData(property);
                    });
                    
                    suggestionsList.appendChild(item);
                });
            })
            .catch(error => {
                console.error('Error looking up property:', error);
                searchStatus.classList.add('d-none');
                
                // Show error
                suggestionsList.innerHTML = `
                    <div class="list-group-item text-center text-danger py-3">
                        <i class="fas fa-exclamation-circle mr-2"></i> Error: ${error.message || 'Failed to lookup property'}
                    </div>
                `;
            });
    }
    
    // Event listener for typing in address field (debounced)
    addressInput.addEventListener('input', function() {
        const address = this.value.trim();
        
        // Clear previous timeout
        if (searchTimeout) {
            clearTimeout(searchTimeout);
        }
        
        // Set new timeout (300ms delay)
        searchTimeout = setTimeout(function() {
            lookupProperty(address);
        }, 300);
    });
    
    // Handle keyboard navigation in suggestions
    addressInput.addEventListener('keydown', function(e) {
        const items = suggestionsList.querySelectorAll('a.list-group-item-action');
        
        if (!suggestionsContainer.classList.contains('d-none')) {
            let activeItem = suggestionsList.querySelector('a.active');
            let activeIndex = -1;
            
            // Find active item index
            if (activeItem) {
                activeIndex = Array.from(items).indexOf(activeItem);
            }
            
            // Down arrow
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (activeItem) {
                    activeItem.classList.remove('active');
                }
                
                if (activeIndex < items.length - 1) {
                    items[activeIndex + 1].classList.add('active');
                    items[activeIndex + 1].scrollIntoView({ block: 'nearest' });
                }
            }
            
            // Up arrow
            else if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (activeItem) {
                    activeItem.classList.remove('active');
                }
                
                if (activeIndex > 0) {
                    items[activeIndex - 1].classList.add('active');
                    items[activeIndex - 1].scrollIntoView({ block: 'nearest' });
                }
            }
            
            // Enter key - select highlighted item
            else if (e.key === 'Enter' && activeItem) {
                e.preventDefault();
                activeItem.click();
            }
            
            // Escape key - hide suggestions
            else if (e.key === 'Escape') {
                e.preventDefault();
                suggestionsContainer.classList.add('d-none');
            }
        }
    });
    
    // Focus events
    addressInput.addEventListener('focus', function() {
        const address = this.value.trim();
        if (address.length >= 3) {
            lookupProperty(address);
        }
    });
    
    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!suggestionsContainer.contains(e.target) && e.target !== addressInput) {
            suggestionsContainer.classList.add('d-none');
        }
    });
});
</script>
{% endblock %}